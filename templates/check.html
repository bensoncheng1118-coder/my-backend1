<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interacoustics AC40 High-Fidelity Simulator</title>
    <style>
        :root {
            --ac-bg: #f2f2f5;
            --ac-bezel: #2a2a2e;
            --ac-btn-black: #1a1a1c;
            --ac-btn-red: #cc3333;
            --ac-btn-blue: #0066cc;
            --ac-btn-green: #16a085;
            --ac-btn-orange: #d35400;
            --ac-btn-yellow: #f1c40f;
            --led-on: #00ff00;
            --led-off: #444;
        }

        body {
            margin: 0;
            background: #d1d1d6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Segoe UI', Arial, sans-serif;
            padding: 20px;
        }

        .ac40-console {
            width: 1250px;
            background: var(--ac-bg);
            border-radius: 10px;
            box-shadow: 0 50px 100px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            border: 4px solid #999;
            position: relative;
        }

        .lcd-area {
            background: var(--ac-bezel);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .lcd-frame {
            width: 800px;
            height: 400px;
            background: #000;
            border: 6px solid #111;
            border-radius: 4px;
            position: relative;
            color: #ccc;
        }

        .bezel-btns {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .btn-func {
            width: 40px;
            height: 14px;
            background: #333;
            border: 1px solid #444;
            cursor: pointer;
        }

        .main-panel {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
        }

        .panel-col {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .btn-group-header {
            font-size: 10px;
            font-weight: 900;
            color: #555;
            margin-bottom: 5px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 3px;
        }

        .btn-matrix {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px 15px;
        }

        .button-unit {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 60px;
        }

        .label {
            font-size: 8px;
            font-weight: bold;
            text-align: center;
            color: #444;
            margin-bottom: 2px;
        }

        .btn-sq {
            width: 50px;
            height: 35px;
            background: var(--ac-btn-black);
            border: none;
            border-radius: 3px;
            cursor: pointer;
            box-shadow: 0 5px #000;
            position: relative;
        }

        .btn-sq:active {
            transform: translateY(2px);
            box-shadow: 0 3px #000;
        }

        .btn-sq.active {
            filter: brightness(1.5);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.4);
        }

        .led {
            width: 14px;
            height: 4px;
            background: var(--led-off);
            margin-top: 2px;
            border-radius: 1px;
        }

        .btn-sq.active+.led {
            background: var(--led-on);
            box-shadow: 0 0 8px var(--led-on);
        }

        .color-red {
            background: var(--ac-btn-red) !important;
        }

        .color-blue {
            background: var(--ac-btn-blue) !important;
        }

        .color-green {
            background: var(--ac-btn-green) !important;
        }

        .color-orange {
            background: var(--ac-btn-orange) !important;
        }

        .color-yellow {
            background: var(--ac-btn-yellow) !important;
        }

        .control-hub {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 10px;
        }

        .dial-knob {
            width: 140px;
            height: 140px;
            background: #1a1a1a;
            border-radius: 50%;
            border: 8px solid #999;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            cursor: ns-resize;
            position: relative;
            transition: transform 0.1s;
        }

        .dial-knob::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 5px;
            height: 20px;
            background: white;
            transform: translateX(-50%);
        }

        .enter-btn {
            width: 55px;
            height: 55px;
            background: #ccc;
            border-radius: 50%;
            border: 3px solid #999;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7px;
            font-weight: 800;
            text-align: center;
        }

        canvas {
            width: 100%;
            height: 100%;
            background: #000;
            cursor: crosshair;
        }

        .shelf-label {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            padding: 5px 20px;
            border: 1px solid #ccc;
            font-weight: 900;
            color: #333;
        }
    </style>
</head>

<body>

    <div class="ac40-console">
        <div class="lcd-area">
            <div class="lcd-frame">
                <canvas id="audiogramCanvas"></canvas>
            </div>
            <div class="bezel-btns">
                <div class="btn-func" title="Shift"></div>
                <div class="btn-func" title="Setup"></div>
                <div class="btn-func"></div>
                <div class="btn-func"></div>
                <div class="btn-func"></div>
                <div class="btn-func"></div>
                <div class="btn-func"></div>
                <div class="btn-func" title="Tests"></div>
                <div class="btn-func" title="Delete Point" onclick="delPt()"></div>
                <div class="btn-func" title="Clear All" onclick="clearAll()"
                    style="background: #500; border: 1px solid #700;"></div>
                <div class="btn-func" title="Save Session"></div>
                <div class="btn-func" title="Print"></div>
            </div>
        </div>

        <div class="main-panel">
            <div class="panel-col">
                <div class="btn-group-header">CHANNEL 1 INPUT</div>
                <div class="btn-matrix">
                    <div class="button-unit">
                        <div class="label">Tone Warble</div><button class="btn-sq active" id="c1-tone"
                            onclick="selStim(1, 'tone')"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">Wavefile</div><button class="btn-sq" id="c1-wave"
                            onclick="selStim(1, 'wave')"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">1 Mic 2</div><button class="btn-sq"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">1 CD 2</div><button class="btn-sq"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">NB N</div><button class="btn-sq" id="c1-nb"
                            onclick="selStim(1, 'nb')"></button>
                        <div class="led"></div>
                    </div>
                </div>

                <div class="btn-group-header" style="margin-top: 10px;">CHANNEL 1 OUTPUT</div>
                <div class="btn-matrix">
                    <div class="button-unit">
                        <div class="label">Right Insert</div><button class="btn-sq color-red active" id="c1-rout"
                            onclick="selOut(1, 'Right', 'Phone')"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">Left Insert</div><button class="btn-sq color-blue" id="c1-lout"
                            onclick="selOut(1, 'Left', 'Phone')"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">R Bone L</div><button class="btn-sq color-green"
                            onclick="selOut(1, null, 'Bone')"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">1 FF 2</div><button class="btn-sq"></button>
                        <div class="led"></div>
                    </div>
                </div>

                <div class="control-hub">
                    <div class="button-unit">
                        <div class="dial-knob" id="dial-1"></div>
                        <div class="label" style="font-size:10px; margin-top:5px;">HL CH 1</div>
                    </div>
                    <div class="enter-btn" onmousedown="oscStart(1)" onmouseup="oscStop()">TONE SWITCH<br>ENTER</div>
                </div>
            </div>

            <div class="panel-col" style="align-items: center;">
                <div class="btn-matrix" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="button-unit">
                        <div class="label">1dB 2dB 5dB</div><button class="btn-sq" onclick="cycleStep()"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">Ext Range</div><button class="btn-sq color-orange" id="ext-range"
                            onclick="toggleExt()"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">Sync</div><button class="btn-sq" id="sync-btn"
                            onclick="toggleSync()"></button>
                        <div class="led"></div>
                    </div>
                </div>

                <div class="btn-matrix" style="margin-top: 20px;">
                    <div class="button-unit">
                        <div class="label">Man Rev</div><button class="btn-sq"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">Single Multi</div><button class="btn-sq"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">Man Rev</div><button class="btn-sq"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">Sim</div><button class="btn-sq"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">Alt</div><button class="btn-sq"></button>
                        <div class="led"></div>
                    </div>
                </div>

                <div style="display: flex; gap: 20px; margin-top: 30px;">
                    <div class="button-unit">
                        <div class="label">Store</div><button class="btn-sq color-yellow" onclick="store()"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">No Resp</div><button class="btn-sq" onclick="storeNR()"></button>
                        <div class="led"></div>
                    </div>
                </div>

                <div style="display: flex; gap: 20px; margin-top: 10px;">
                    <div class="button-unit">
                        <div class="label">Freq Down</div><button class="btn-sq" onclick="adjFreq(-1)"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">Freq Up</div><button class="btn-sq" onclick="adjFreq(1)"></button>
                        <div class="led"></div>
                    </div>
                </div>
            </div>

            <div class="panel-col">
                <div class="btn-group-header">CHANNEL 2 INPUT</div>
                <div class="btn-matrix">
                    <div class="button-unit">
                        <div class="label">Tone Warble</div><button class="btn-sq"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">Wavefile</div><button class="btn-sq"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">NB N</div><button class="btn-sq active" id="c2-mask"
                            onclick="selStim(2, 'nb')"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">1 Mic 2</div><button class="btn-sq"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">Off</div><button class="btn-sq"></button>
                        <div class="led"></div>
                    </div>
                </div>

                <div class="btn-group-header" style="margin-top: 10px;">CHANNEL 2 OUTPUT</div>
                <div class="btn-matrix">
                    <div class="button-unit">
                        <div class="label">Right Insert</div><button class="btn-sq color-red"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">Left Insert</div><button class="btn-sq color-blue active" id="c2-lout"
                            onclick="selOut(2, 'Left', 'Phone')"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">Insert Mask</div><button class="btn-sq color-green"></button>
                        <div class="led"></div>
                    </div>
                    <div class="button-unit">
                        <div class="label">1 FF 2</div><button class="btn-sq"></button>
                        <div class="led"></div>
                    </div>
                </div>

                <div class="control-hub">
                    <div class="enter-btn" onmousedown="oscStart(2)" onmouseup="oscStop()">TONE SWITCH<br>ENTER</div>
                    <div class="button-unit">
                        <div class="dial-knob" id="dial-2"></div>
                        <div class="label" style="font-size:10px; margin-top:5px;">HL CH 2</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="shelf-label">PTA (Interacoustics AC40)</div>
    </div>

    <script>
        const canvas = document.getElementById('audiogramCanvas');
        const ctx = canvas.getContext('2d');
        const freqs = [125, 250, 500, 750, 1000, 1500, 2000, 3000, 4000, 6000, 8000];
        const steps = [5, 2, 1];

        let audioCtx = null;
        let osc = null, gainNode = null;
        let noise = null, noiseGain = null;

        let state = {
            freqIdx: 4,
            db1: 30, db2: 50,
            side: 'Right',
            transducer: 'Phone',
            extRange: false,
            sync: false,
            stepIdx: 0,
            stim1: 'tone', stim2: 'nb',
            results: { Right: [], Left: [] }
        };

        function init() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = canvas.offsetWidth * dpr;
            canvas.height = canvas.offsetHeight * dpr;
            ctx.scale(dpr, dpr);
            draw();
        }

        function draw() {
            const w = canvas.width / devicePixelRatio, h = canvas.height / devicePixelRatio;
            const pad = 50, gridH = h - pad * 2 - 40;
            ctx.fillStyle = '#000'; ctx.fillRect(0, 0, w, h);

            ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0, 0, w, 30);
            ctx.fillStyle = '#0f0'; ctx.font = 'bold 12px Consolas';
            ctx.fillText(`CH1: ${freqs[state.freqIdx]}Hz ${state.db1}dB  |  CH2: ${state.db2}dB ${state.stim2.toUpperCase()}`, 15, 20);
            if (state.sync) ctx.fillText("SYNC ACTIVE", w - 120, 20);

            ctx.strokeStyle = '#333'; ctx.lineWidth = 1;
            freqs.forEach((f, i) => {
                const x = pad + (i * (w - pad * 2) / (freqs.length - 1));
                ctx.beginPath(); ctx.moveTo(x, pad + 30); ctx.lineTo(x, h - pad); ctx.stroke();
                ctx.fillStyle = '#666'; ctx.font = '10px Arial'; ctx.fillText(f, x - 12, pad + 25);
            });

            for (let j = 0; j <= 13; j++) {
                const y = pad + 30 + (j * gridH / 13);
                const db = -10 + j * 10;
                ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w - pad, y); ctx.stroke();
                ctx.fillText(db, pad - 25, y + 4);
                if (!state.extRange && db > 100) {
                    ctx.fillStyle = 'rgba(255,0,0,0.1)';
                    ctx.fillRect(pad, y, w - pad * 2, gridH / 13);
                }
            }

            renderSet('Right', 'red', 'O', '<');
            renderSet('Left', '#4d94ff', 'X', '>');
        }

        function renderSet(s, color, airSym, boneSym) {
            const w = canvas.width / devicePixelRatio, h = canvas.height / devicePixelRatio;
            const pad = 50, gridH = h - pad * 2 - 40;
            const pts = state.results[s].sort((a, b) => a.f - b.f);
            if (!pts.length) return;

            ctx.strokeStyle = color; ctx.lineWidth = 2;
            ctx.beginPath();
            pts.forEach((p, i) => {
                if (p.type !== 'Phone') return;
                const x = pad + (freqs.indexOf(p.f) * (w - pad * 2) / (freqs.length - 1));
                const y = pad + 30 + ((p.d + 10) * gridH / 130);
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.stroke();

            pts.forEach(p => {
                const x = pad + (freqs.indexOf(p.f) * (w - pad * 2) / (freqs.length - 1));
                const y = pad + 30 + ((p.d + 10) * gridH / 130);
                ctx.fillStyle = color; ctx.font = 'bold 16px Arial';
                let sym = p.type === 'Phone' ? airSym : boneSym;
                if (p.nr) sym += '↓';
                ctx.fillText(sym, x - 8, y + 6);
            });
        }

        function updateUI() {
            document.getElementById('dial-1').style.transform = `rotate(${(state.db1 + 10) * 2}deg)`;
            document.getElementById('dial-2').style.transform = `rotate(${(state.db2 + 10) * 2}deg)`;
            document.getElementById('ext-range').classList.toggle('active', state.extRange);
            document.getElementById('sync-btn').classList.toggle('active', state.sync);
            draw();
        }

        function adjFreq(d) { state.freqIdx = Math.max(0, Math.min(freqs.length - 1, state.freqIdx + d)); updateUI(); }
        function selOut(ch, side, type) { if (ch === 1) { state.side = side || state.side; state.transducer = type; } updateUI(); }
        function toggleExt() { state.extRange = !state.extRange; updateUI(); }
        function toggleSync() { state.sync = !state.sync; updateUI(); }
        function cycleStep() { state.stepIdx = (state.stepIdx + 1) % steps.length; }

        function store() {
            state.results[state.side] = state.results[state.side].filter(p => p.f !== freqs[state.freqIdx]);
            state.results[state.side].push({ f: freqs[state.freqIdx], d: state.db1, type: state.transducer, nr: false });
            draw();
        }
        function storeNR() { state.results[state.side].push({ f: freqs[state.freqIdx], d: state.db1, type: state.transducer, nr: true }); draw(); }
        function delPt() { state.results[state.side].pop(); draw(); }
        function clearAll() { if (confirm("確定要清除所有聽力圖數據嗎？")) { state.results = { Right: [], Left: [] }; draw(); } }

        function setupAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function oscStart(ch) {
            setupAudio();
            const f = freqs[state.freqIdx];
            const level = ch === 1 ? state.db1 : state.db2;
            const stim = ch === 1 ? state.stim1 : state.stim2;
            if (stim === 'tone') {
                osc = audioCtx.createOscillator(); gainNode = audioCtx.createGain();
                osc.frequency.value = f; gainNode.gain.value = Math.pow(10, (level - 70) / 20) * 0.1;
                osc.connect(gainNode).connect(audioCtx.destination); osc.start();
            } else {
                const bufferSize = 2 * audioCtx.sampleRate, noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate), output = noiseBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) { output[i] = Math.random() * 2 - 1; }
                noise = audioCtx.createBufferSource(); noise.buffer = noiseBuffer; noise.loop = true;
                noiseGain = audioCtx.createGain(); noiseGain.gain.value = Math.pow(10, (level - 70) / 20) * 0.05;
                noise.connect(noiseGain).connect(audioCtx.destination); noise.start();
            }
        }
        function oscStop() { if (osc) { osc.stop(); osc = null; } if (noise) { noise.stop(); noise = null; } }

        document.getElementById('dial-1').addEventListener('wheel', (e) => {
            e.preventDefault();
            const d = e.deltaY > 0 ? -steps[state.stepIdx] : steps[state.stepIdx];
            state.db1 = Math.max(-10, Math.min(state.extRange ? 120 : 100, state.db1 + d));
            if (state.sync) state.db2 = Math.max(-10, Math.min(120, state.db2 + d));
            updateUI();
        });
        document.getElementById('dial-2').addEventListener('wheel', (e) => {
            e.preventDefault();
            state.db2 = Math.max(-10, Math.min(120, state.db2 + (e.deltaY > 0 ? -5 : 5)));
            updateUI();
        });

        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width / devicePixelRatio);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height / devicePixelRatio);
            const w = 800, h = 400, pad = 50, gridH = 310;
            let fi = Math.round((x - pad) / (700 / 10));
            let db = Math.round((y - pad - 30) / (gridH / 13)) * 10 - 10;
            if (fi >= 0 && fi <= 10 && db >= -10 && db <= 120) {
                state.freqIdx = fi; state.db1 = db; store(); updateUI();
            }
        });

        window.addEventListener('resize', init);
        init(); updateUI();
    </script>
</body>

</html>
